import WebApp from "@twa-dev/sdk";
import { uploadReceipt } from "./lib/api";

export async function submitOrder({ item, playerId, payMethod, file }) {
  WebApp.MainButton.showProgress?.();
  try {
    let screenshot_path = null;
    if (file) {
      const up = await uploadReceipt(file);
      screenshot_path = up.path;
    }
    const userId = WebApp?.initDataUnsafe?.user?.id; // Telegram အတွင်းမှာ ရနိုင်
    const res = await fetch("/api/orders", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        product_name: item.name,
        price: parseInt(String(item.price).replace(/[^\d]/g,""), 10),
        player_id: playerId,
        payment_method: payMethod,
        screenshot_url: screenshot_path
      })
    });
    const data = await res.json();
    if (data?.id) WebApp.showAlert(`Order #${data.id} စာရင်းသွင်းပြီးပါပြီ ✅`);
    else WebApp.showAlert("Order failed");
  } finally { WebApp.MainButton.hideProgress?.(); }
}
